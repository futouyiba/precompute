# 中鱼-预计算+实时计算+校验方案

## 背景

我们有以下几点思考：

1.  **所有的内容都需要在每次抛竿的时候算一次吗？** 比如，同一天气和时段下，鱼的空间分布密度其实是相对固定的。
2.  **前端应当在高效中鱼的水域给出视觉暗示**，例如鱼跃、饵鱼、气泡、游动水痕等。但是不同的天气下，鱼会改变栖息和活跃的区域。这些动态的信息前端如何获取？
3.  **玩家的手法、姿态是以亚秒级进行的尺度。** 比如实际钓鱼中在目标区域小跳，黄金时间只有2-4秒左右，这其中要达到亚秒级的判断/计算，才能得到较为合适的反馈。这样的计算频率，放在哪一端更划算？
4.  **搏鱼的时候需要鱼的状态来影响其行为表现**，客户端如何知道其状态？

## 基本思路

基于上面的思考，考虑这样的模式：

*   **大量计算使用预计算的模式**；空间换时间；
*   **对于依赖玩家动态操作的部分，前端实时计算为主，后端负责校验+动态调整**；
    *   计算过程都依赖于预计算得来的数据资源；

[关联文档: Feishu Sync](https://pisn3u3ony2.feishu.cn/sync/Bonrd0OfNs56ANbUM5DcNfcQnDf)

## 机制、数据分层

### A. StaticEnvAsset（静态环境资产）
*   **内容**：地图结构/地形、深度、结构；鱼对结构亲和（species×structure）；pond 基础丰度（species base abundance）。
*   **输入数据来源**：策划编辑/配置
*   **计算位置**：P（离线构建）
*   **存储形态**：待定
*   **分发**：仅在P端存储，C和S不用

### B. DynamicScenario（动态场景参数）
*   **内容**：天气/时段/风/云量/气压、以及 水温分层参数（例如表层温度、跃层深度、梯度强度等 “全局少量参数”）；
*   **来自**：钓场天气日程表（未来一周）、天气配置表
*   **计算位置**：
    *   天气日程：P 生成（或运营/脚本）
    *   运行时取值：C/S 按“当前服务器时间/场景”读取当前 slot 的参数
*   **存储形态**：待定
*   **分发**：P、C、S都需要用

### C. DerivedEnvField（派生环境场）
*   **例**：鱼状态列表、Light(x,y,z)、DO profile 参数、温度 profile 参数、risk_base(x,y)、food_base(x,y)
*   **计算位置**：P端预计算
*   **存储形态**：待定
*   **分发**：分发给C&S，各自使用

### D. StaticBaitModel（静态饵模型）
*   **内容**：饵种/子类/长度/重量/轮廓/振动/声音/闪光等查表
*   **计算位置**：C
*   **分发**：CS各自计算，不分发

### E. DynamicOperationFeature（动态操作特征）
*   **内容**：姿态序列压缩特征（节奏、速度窗口、停顿、抖动频谱、幅度一致性）→ 映射到 Attraction/刺激通道强度。
*   **计算位置**：C（主算）
    *   S 只做抽检/校验（不能重放全部手势序列就做摘要校验）
*   **分发**：C→S 仅上传 摘要与关键统计（避免带宽和作弊风险）

### F. Synthesis（组装权重池）
*   **内容**：把 “环境侧（derived） + 鱼基础丰度 + 饵模型 + 操作特征 + 鱼状态门控” 组合成：
    *   诱鱼成功判断（包含时间）
    *   候选鱼种权重池
*   **计算位置**：
    *   C（主算）：为了即时反馈与手感
    *   S（复算/校验）：用同一套规则（或降阶近似）对关键结果做一致性校验

### G. Control&Judgement（控制与裁决）
*   **内容**：PRD（防作弊/概率保护/极端值保护）、抽样策略、最终裁决（中/不中、鱼种/品质/长度、奖励落地）
*   **计算位置**：S（权威）
*   **输出**：最终结果 + 回传 C 的“状态码”，再由C端作表现、作鱼AI与搏鱼逻辑

## （讨论）重要选择

*   是否可以前端计算、后端校验，以之为主体框架？**是的**
*   是否可以让前后端的计算共用一套代码/dll？**后续定**
*   在这个前提下，最终的鱼种确定是否放在后端？**是的**
*   预计算得到的数据资产：使用什么结构化的模式，哪些预计算、哪些实时计算；由哪一端进行计算。
*   我们通过形如 `if else` 的程序语言处理更划算，还是通过稀疏vector计算、充分利用SIMD计算更划算；
    *   策划感觉分计算的情况，例如预计算的东西，SIMD更划算，而玩家针对鱼状态，用逻辑处理更划算；
*   能否像策划的原型那样，让鱼分布更视觉化、图形化、可视化？**可以**

---

## 用户故事 UserStory

我们要做的内容是为了设计目标和用户故事服务。

### 分层：
这一部分定义“中鱼系统到底在模拟什么”，以及玩家如何用统计逼近内部状态。它是后面 80 条经验与变量体系的共同底座。

*   **L0｜术语与度量（定义层）**
    *   效率 = 单位时间中鱼数 (CPUE)
    *   鱼口好 = 平均等待时间短
*   **L1｜统计可逼近（反馈层）**
    *   短期有波动
    *   长期统计收敛
    *   一次只改一个变量
*   **L2｜空间与时间的“有效性”边界（规则层）**
    *   有效空间/路径
    *   鱼种竞争 / 稀释
    *   无意义空白区 = 垃圾时间
    *   单一高权重鱼种 → 更高效率
    *   本层还约束竞争与稀释：同一时间、同一有效空间内，目标鱼种越集中，效率越高；鱼种越分散，单位时间命中被稀释。
*   **L3｜物种与难易（物种层）**
    *   警惕 / 饥饿 / 偏好
*   **L4｜策略与操作的边界（体验层）**
    *   策略主导
    *   基础咬口强度
    *   操作及格即平台期
*   **L5｜钓鱼策略谜题符合钓鱼佬经验（体验层2）**
    *   可见 “中鱼-预计算+实时计算+校验方案” 章节；

**格式图例：**
*   这种条目是我们希望有，且已经做的了
*   这种条目是偏玄学，我们不做的
*   这种条目是我们还没做，想做到的

---

## 预计算的取舍

主要考虑几点因素：
*   预计算数据文件的体积影响。影响玩家下载量。
*   是否被天气影响。
*   是否依赖于玩家操作。

## 实施步骤（需讨论）

### 1.1 预计算v1 - 基础信息
a. **确定预计算的基本技术框架**
b. **完成对配置表**（静态鱼习性、钓场鱼、钓场属性+动态天气）和 **地形结构**（深度、结构体）这两方面输入信息的采集
c. **输出派生环境场**（鱼状态以外的）
    *   方案1：`fishTypes * 2D平面（俯视视角）` 和 `fishTypes * 1D深度（水柱采样）`
    *   方案2: `x*y*z*fishTypes`
    *   个数：1个钓场 * >2个时段的序列（真实时间1周更佳）
d. **可进行数据可视化查看**
    *   全鱼种的热度预览（3D）
    *   单鱼种的热度预览（3D）

### 1.2 预计算v2 - 鱼状态（若姿态优化来不及，则以此作为第2步）
a. **确定鱼状态逻辑的相关配置模式；并实现配置流程**
    *   配置表/规则引擎/代码
    *   策划选择两种典型的状态，进行配置
b. **可根据配置、地形结构，输出 不同区域 * 不同鱼种 的 鱼状态列表**
    *   颗粒度在这一步得到确定
c. **可进行数据可视化查看**
    *   单鱼种的状态 混色查看（3D）
    *   多鱼种的单状态 叠加查看（3D）

### 1.3 实时计算v1 - 诱鱼计算（若姿态优化完成的早，则以此作为第2步）
a. **（基于改进后的饵姿态模块）姿态触发诱鱼计算**
b. **从网络拉取派生环境场**
    *   这一步不考虑下载UI、下载时机等细节
c. **根据派生环境场、玩家使用的饵种、玩家饵姿态时间序列、饵位置时间序列，在恰当的时机得到中鱼结果**
    *   包含随机、圆桌理论等

### 1.4 实时计算v2 - 状态诱鱼
a. 这个版本是一个非常重要的节点；
b. 让玩家可针对鱼的不同状态，使用针对的策略得到更好的结果
c. 将前后端的流程打通
    *   其中校验为 `nice to have`，不强求
d. 建立 策略-状态 针对逻辑的实现模式
    *   配置表/规则引擎/代码
    *   策划选择两种典型的状态，进行配置
e. 策划对前几个sprint的数据进行更齐全的配置

### 1.5 巩固增强 - 钩大小 & 警惕度 & 活性 & 引线
a. ……

### 1.6 鱼口暗示表现 - 3D表现
a. ……

### 1.7 光照逻辑 & 时间序列逻辑
a. ……

### 1.8 鱼口波动 & 区域消长联动

### 1.9 矫正系数

### 1.10 动态权重调整1

### 1.11 动态权重调整2

---

## 2. 以姿态/手法激发诱鱼

以C端计算为主，则可以以姿态/手法颗粒，而非时间颗粒来激发诱鱼、随机计算。为此，我们将算法整体从固定5秒触发，改为姿态颗粒触发。鉴于当前姿态还未颗粒化，本改动将与姿态优化同期制作。

**基本规则：**
*   各钓法有自己的高效姿态、低效姿态；
*   所有高效姿态都会以“颗粒”状的时间切分，并不断累积/提升姿态得分；
*   低效姿态不触发/以极长时间触发诱鱼/中鱼计算；
*   触发时间点在一个姿态颗粒的起始时；
*   姿态主要是 1. 触发诱鱼 2. 提供姿态种类、得分数据，供状态进行主要计算；

例如，每次抽搐500~1200ms，每次都触发；匀收直走过程的每个颗粒（1000ms）触发。

**细节讨论：**
*   **姿态时间长度不同，是否归一化**
*   **同一个姿态，长时间做和短时间做，诱鱼效果的差别**：
    *   怎么定位、设计
    *   怎么体现
*   **是否加个诱鱼基础乘数，来解决各姿态时间不均的抹平**

---

## 3. 鱼状态

### 3.1 背景

**针对鱼的攻击性状态：快速检索和激进拟饵操作**

当鱼处于攻击状态，特别是捕食性鱼类时，使用快速检索和具有激进表现力的饵料，往往能触发它们的捕食本能。
*   **快检钓法**：对付攻击性鱼类，如鳡鱼或黑鲈，可以使用快速检索路亚（如高速旋转亮片或振动拟饵），模拟猎物逃逸的状态，迅速引发鱼的捕食反应。
*   **大型拟饵**：对于食性凶猛的鱼类，如狗鱼、北美大口鲈鱼，使用较大号的拟饵，如“波巴斯”（Popper）或“振动拟饵”（vibration lure），并施加跳跃或剧烈抖动，可以大大增加咬钩的几率。

**针对鱼的气压变化：根据气压调整钓鱼策略**

气压对鱼类的行为影响很大，特别是气压的快速变化会让鱼的活跃度发生明显改变。
*   **低气压期的鱼类活跃度**：低气压时，水中的溶氧量较低，鱼类往往游向浅水区并变得更加活跃。此时可以选择靠近岸边的浅水区作钓，使用浮漂钓或浅层钓具，鱼类可能会更加积极地觅食。
*   **高气压期的深水钓法**：在高气压条件下，鱼类的活跃度较低，往往会游向较深的水域或停留在水底附近。此时可以使用“重铅钓法”或“缓沉钓法”，将饵料送到鱼类可能停留的深水区，并使用慢速回收以适应鱼的低活跃状态。

**针对鱼的夜间觅食状态：夜钓和发光饵料的使用**
*   **夜间使用发光饵料或荧光线**：夜间作钓时，光线不足，鱼更容易被视觉和声波吸引。使用带有发光功能的软体拟饵、亮片等可以提高鱼对钓饵的关注度。同时，选择带有荧光标志的钓线，方便观察鱼的咬钩情况。
*   **静音漂钓法**：夜钓时环境安静，声音容易吓到鱼。使用静音漂钓法，即避免快速回收和抖动动作，确保钓具在水中尽量自然，诱使鱼在夜间接近钓饵。

**针对鱼的领地意识：利用巢穴防守策略**
*   **巢穴区域的挑逗式钓法**：例如在黑鲈的筑巢期间，雄性鲈鱼会守护巢穴，并攻击任何接近巢穴的入侵者。此时可以使用“大尺寸的拟饵”或者“色彩鲜艳的爆水蛙”直接抛向巢穴，缓慢收线并反复抖动饵料以挑逗鱼的神经，迫使它们出击攻击。
*   **饵料模拟入侵者**：可以使用外形类似于小型入侵者的饵料（如小型螃蟹、龙虾、蜥蜴等软体拟饵），并在巢穴附近反复操作，以模拟天敌接近巢穴的场景，引发防御性攻击。

### 3.2 鱼受击状态
每个鱼种对应多种不同的受击状态，受击状态会对环境变量、玩家的攻击策略作反馈，输出。
[关联文档](https://pisn3u3ony2.feishu.cn/sync/IG52dUWXCsIeGCb70E7cRc9Dnnb)

*   **受击状态采用组件化设计**。
    *   状态是一个共用库，每种鱼配置可以达到的状态有哪些。
    *   一种鱼可以配置多个 条件：状态 组，每个组内描述了什么条件下可获得什么状态；换句话说，一种鱼可以配置多种状态。
    *   一种鱼可以同时有多个生效的状态。
*   **受击状态需满足其判断条件。不满足的受击状态不会生效。**
    *   判断条件形式多样，需要较为灵活的配置方式，见“配置表需求”章节。
    *   判断条件可以兼容无判断/始终为真。（用于给鱼配置特殊习性）
*   **各受击状态可配置隶属的科（大类）和在大类中的优先级。**
    *   有多个受击状态满足条件时，不一定每个都生效：每个大类当中，只有优先级最高的一个受击状态可生效，并进行适配逻辑、适配系数的计算。
*   **各受击状态有其自身的逻辑能力、计算能力。**
    *   可调用中鱼相关的变量，例如：
        *   玩家操作技法种类，及其评分
        *   饵的种类、长度、颜色
        *   钓场天气、季节
        *   饵所在点的温度、结构信息
    *   可通过其逻辑、公式，计算出适配系数

**受击状态科（大类）举例：**

*   **觅食状态**。有超量进食需求，例如晨、暮觅食，换季超量觅食，还有繁殖期超量进食。
    *   条件主要与季节、时间段相关。
    *   对鱼口整体有提升。
    *   对偏小的鱼饵有增量提升（偏态曲线影响）。
    *   其中的夜间觅食状态鼓励玩家以夜光钓饵作钓。
*   **迟缓、低活跃、休息状态**。
    *   条件主要和季节、天气相关。
    *   对鱼口整体有降低。
    *   鼓励玩家以较为缓慢精细的技法作钓，对玩家的缓慢拟饵速度操作有一定的鱼口补偿。
*   **护卫、攻击状态**。护巢、护卵。
    *   条件主要为季节、地形范围标签。
    *   对鱼口整体有提升。
    *   对偏小、偏大的饵有超量的鱼口提升。
    *   对非常规食物的饵类型有超量的鱼口提升。
*   **应激状态**。
    *   条件主要为日期、外部数据种子。
    *   每种鱼可猎食的饵种类中，每天抽取出一种特别加成饵。
*   **浮沉状态**。
    *   条件主要和季节、天气相关。
    *   对不同水深、水层的鱼口有增有减。
*   **常规/idle/巡游/藏匿状态**。其中会计算某一类鱼的特殊习性对玩家攻击策略的适配。

### 3.3 受击状态生效

**生效逻辑步骤：**
1.  用鱼种检索出所有配置的状态
2.  判断条件是否符合，只有符合判断条件的受击状态才进入下一步
3.  在每一个受击状态科（大类）里，取（若有）优先级最高的一个受击状态生效

其中判断条件使用配置表（见“配置方法1”章节）；或使用grule-rule-engine等规则引擎来配置。

**判断条件中所使用的变量包括：**
*   时段、水温、气温、季节、水层、深度、天气、地形范围标签（饵点所属的标签区域带来的 标签：值 键值对列表）

### 3.4 受击状态的适配系数计算

生效的受击状态 可根据 环境变量 & 玩家攻击策略 计算得到 两部分适配系数。
*   一部分是和玩家攻击策略（及其评分）共同检索&计算得来的**评分适配系数**。
*   另一部分是**适配调整系数**。

### 3.5 评分适配系数

**对于路亚，先计算每个受击状态的评分适配系数，再汇总：**

```
for 每个状态：
    评分适配系数 = 插值方法(适配系数_0级，适配系数_最高级，最新技法评分等级/最新技法评分最高等级)
总评分适配系数 = sum(各状态评分适配系数)
```

其中 适配系数-0级、适配系数-最高级、插值方法 在 “受击状态-攻击策略对应表”中配置。
*   状态为严格检索，若检索不到则检索为空，返回 0
*   饵种和技法都优先找准确对应项，若没有则找有没有 fallback，若也没有 fallback 则检索为空，返回 0

**对于浮钓，评分适配系数不需要使用受击状态进行检索、汇总，按照下面方式一次计算得到：**
*   If 最新技法==静漂：
    *   `浮钓评分适配系数 = lerp(静漂0级适配系数，静漂最高级适配系数，静漂技法评分等级/静漂技法评分最高等级)`
*   If 最新技法==施力：
    *   `浮钓评分适配系数 = lerp(施力0级适配系数，施力最高级适配系数，施力技法评分等级/施力技法评分最高等级)`

### 3.6 适配调整系数

另一部分是适配调整系数，得出和玩家操作技法、评分无关，但和饵种、饵长、饵速度、环境因素有关的调整系数。对于浮钓、路亚，均需要先计算每个受击状态带来的适配调整系数，再汇总。

计算时引用的变量包括：
*   饵鱼长度比（超出比例、大小符号）
*   饵移动平均速度
*   饵跳动频率
*   最新操作技法种类
*   最新操作技法评分等级
*   水层、深度、水温、标签区域 标签：值、噪音

### 3.7 配置方案

**配置方法1：** 受击状态条件组表 (配置示例)

| 序号 | 条件组名 | 比较对象1 | 符号 | 数值 | 比较对象2 | 符号 | 数值 | 比较对象3 | 符号 | 数值 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| #0 | cdt_summer | temperature | gt | 30 | season | eq | summer | | | |
| #1 | cdt_spring | period | eq | x00_enum_mrng | date | gt | 0501 | date | lt | 0620 |
| #2 | cdt_unlimit | bound | contain | x01_spawn_assault | season | eq | 12-15 | | | |

*注：比较对之间为 AND 关系*

**配置方法2：**
使用 `gorule-rule-engine` 等规则引擎来配置判定条件和状态的分支逻辑；
使用 `govaluate` 等表达式引擎来配置状态的适配系数计算公式。

**方法3：文本代码即规则**
像写魔兽技能那样，通过函数文本来表达。

---

## 4. 光照适应系数

### 4.1 概述
鱼倾向于在光照度适合的条件下活动和进食。光照适应系数表示某鱼种对饵点位置的光照强度的适应程度，浮点数，一般取值0~1之间；上限为 2.0：
*   值越接近1，表示鱼对饵点的光照度越适应，也会让此鱼种的权重越高；
*   值越接近0，则越难钓到这种鱼；等于0时不可能钓到；
*   少数的情况下会让光照适应系数达到1.0~2.0之间，模拟爆口，或向上调整。

### 4.2 配置&计算步骤

1.  **给鱼种配置**：`最喜光照度` 和 `光照衰减`；
2.  **给时段、天气配置**：`无阴影处光照度` & `阴影中光照度`、`光照乘数`；钓场配置 `水体光衰减系数`；
3.  **计算 Surface Light**：从饵点的(x,z)直接向上找到水面的点，判断是否在阴影下。
4.  **计算 Underwater Light**：`underwater_light = adjustedSurfaceLight * (float)Math.Pow(waterAttenuation, baitDepth);`
5.  **取对数**：`log_light = math.log(underwater_light + 1e-6)`
6.  **计算钟形曲线适应度**：
    ```python
    def calculate_light_affinity(fish_config, map_config, bait_depth, surface_light):
        # ... (见上文公式) ...
        mu = fish_config.prefer_light
        sigma = fish_config.light_tolerance
        exponent = -((log_light - mu) ** 2) / (2 * (sigma ** 2))
        light_affinity = exp(exponent)
        return clamp(light_affinity, 0.0, 1.0)
    ```

**关于晴天钓阴影：**
结论：拟采用实时光照采集方式（Bakery/Unity烘焙光照贴图采样）。

---

## 5. 矫正系数

与鱼状态无关，取决于环境变量、饵、技法。直接从 “适配系数矫正”表中根据条件检索得到。

### 5.1 颜色矫正系数

**影响因素：**
1.  **鱼类视觉能力**：不同鱼类对颜色敏感度不同（红/绿/蓝），低光下依赖黑白感知（高对比度）。
2.  **水体透明度和深度**：
    *   浅水：亮色（白、黄、橙）通常效果好。
    *   深水：红色光被吸收，蓝、紫、绿、白效果更好。
    *   浑水：荧光色、高对比度（黑+亮黄）更好。
3.  **光照条件**：
    *   晴天：自然色调（银、灰、绿）。
    *   阴天/低光：高对比度（黑、白、橙、荧光）。

### 5.2 时间序列效果
*   连续经过几个适宜的天气，鱼饱食之后食欲下降；
*   暴雨/大风前后，鱼口暴涨；暴雨之中，鱼口下降；

---

## 6. （未实现的）结构相关

*   **迁徙路径**：即“高速公路”，比加油站低，比一般位置高；
*   **晕染/结构距离衰减**：离结构体越远，效果打折扣。
*   **溶氧量及亲和度**：前期用结构体+特殊状态表达，后续用贴近水文环境的方法计算。

---

## 7. 鱼口波动

鱼口波动的目的是：
*   让追鱼口的社交体验有所依托。
*   避免抄作业/机械式执行。
*   模拟现实中鱼由于一些因素带来的增减、迁移。

**波动区域 (Fluctuation Area)**
波动区域是编辑器中区域的一种，可配置相关标签：值。例如几个草区，鱼可能在其中游来游去，一个时段在这个地方密，另一个时段在那个地方密。

**波动类型：**
*   **随机事件**：接近Roguelike玩法（如果树掉落、洄游超量来袭、突发小雨）。
*   **常规性鱼口波动**
*   **常规性多区域此消彼长**
*   **特定饵的喜好**

---

## 8. 动态权重调整（控制逻辑）

### 模块分类
*   **前置**：可配置跳过权重计算，直接得到抽奖结果
*   **后置**：不可跳过计算，只能修改权重

### 功能
*   **PRD**：改变随机的波动性（防非/保底），不改变数学期望。
*   **阶段性期望调整**：通过调整权重改变价值期望或频率期望。
*   **运营性中鱼节奏调整**：例如针对付费人群或活动。
*   **运营性期望调整**。

### 鱼种标签
*   **动态/静态标签**
*   **场景标签**：价值标签（用于调整阶段收益）、其他类别标签（用于特殊体验阶段）。

### 表现
*   **3D表现**：饵鱼游动、区域条形水波、气泡、鱼跃、暗影、果树掉落。
*   **UI**：天气预告、活跃鱼（相对高权重鱼种提示）、鱼/饵信息显示。
